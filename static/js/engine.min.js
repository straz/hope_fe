const RESET_LOCAL_STORE=!1;const DEFAULT_WORLD="simple",WORLD_KEY="world",CONFIG_KEY="config",PAGE_KEY="saved_page";var WORLD=null,TIMELINE=null,CONFIG=null,READY=null;class World{constructor(e){for(var t in this.name=e.name,this.id=e.id,this.hopes=e.hopes,this.regrets=e.regrets,this.pages={},e.pages){let o=new Page(this,e.pages[t]);this.pages[t]=o}for(var t in e.pages){let o=this.pages[t],s=e.pages[t];if("next"in s){let e=this.pages[s.next];o.next=e}}this.first_page=this.pages[e.first_page]}}class Page{constructor(e,t){console.log("load page",t),this.world=e,"meta"in t&&(this.context=t.meta),this.text=t.text,"next_id"in t&&(this.next_id=t.next_id),this.context={},"choices"in t&&(this.choices=t.choices)}recalc(){if("next"in this)return{next:this.next}}get_context(e){}}class Timeline{constructor(e){this.world=e,this.pages=[],this.recalc_pages(e.first_page);let t=window.localStorage.getItem(PAGE_KEY);this.page_index=null==t?0:parseInt(t)}current_page(){return this.pages[this.page_index]}go_next(){let e=this.page_index;return this.pages.length==e+1?e:(this.page_index+=1,window.localStorage.setItem(PAGE_KEY,this.page_index),this.page_index)}go_prev(){return 0==this.page_index?current:(this.page_index-=1,window.localStorage.setItem(PAGE_KEY,this.page_index),this.page_index)}page_loc(){return{page_index:this.page_index,page_count:this.pages.length}}score_all(){return{score:0,out_of:6}}recalc_pages(e){this.pages.push(e);let t=e.recalc();if(null!=t&&"next"in t){let e=t.next;this.recalc_pages(e)}}}function setup_world(){let e=window.localStorage.getItem("world"),t=function(e){WORLD=new World(e),window.localStorage.setItem("world",JSON.stringify(e)),TIMELINE=new Timeline(WORLD)};return null==e?$.getJSON("worlds/simple/build.json",t):(WORLD=new World(JSON.parse(e)),TIMELINE=new Timeline(WORLD),$.Deferred().resolve(WORLD))}function load_config(){let e=window.localStorage.getItem("config");CONFIG=null==e?{}:JSON.parse(e)}function save_config(){window.localStorage.setItem("config",JSON.stringify(CONFIG))}$(document).ready(initialize);const scroll_amount="200px";var scroll_lock=!1,scroll_wait=1e3,has_choices=!1,active_choice=null;function initialize(){load_config(),READY=setup_world(),null!=CONFIG&&"setColor"in CONFIG&&$(".case").css("background-color",CONFIG.setColor),$(".case").css("display","block"),marked.setOptions({smartypants:!0}),$(".crank .up").click(go_prev),$(".crank .down").click(go_next),$(".page_text").scroll(on_text_scroll),$(".dpad").click(on_click_dpad),$(".abgroup .outer.ab").click(on_click_ab),$(".gear_panel .gear_toggle").click(on_click_gear),$(".gear_panel .set_color").click(on_click_setcolor),$(document).keypress(on_keypress),update_page()}function now_showing(){return"none"!=$(".intro").css("display")?"intro":"none"!=$(".choices").css("display")?"choices":"timeline"}function show_intro(){$(".page_text, .statusbar").hide(),$(".intro").show()}function hide_intro(){$(".page_text, .statusbar").show(),$(".intro").hide()}function on_click_ab(e){$(e).hasClass("ab")?target=$(e):target=$(e.target).closest(".outer"),"intro"!=now_showing()&&"choices"==now_showing()&&(target.hasClass("a")?active_choice="A":target.hasClass("b")&&(active_choice="B"),update_checks(!0))}function on_keypress(e){let t=String.fromCharCode(e.charCode).toUpperCase();"A"==t?on_click_ab($(".abgroup .a")):"B"==t&&on_click_ab($(".abgroup .b"))}function go_next(e){is_page_bottom()?READY.then((()=>{TIMELINE.go_next(),update_page()})):$(".page_text").animate({scrollTop:"+=200px"},800)}function go_prev(){is_page_top()?READY.then((()=>{TIMELINE.go_prev(),update_page()})):$(".page_text").animate({scrollTop:"-=200px"},800)}function on_click_dpad(e){if("intro"==now_showing())return hide_intro(),void update_page();let t=$(e.target);if(t.hasClass("east")){if("timeline"==now_showing()&&has_choices)return void show_choices()}else if(t.hasClass("west")){if("choices"==now_showing())return hide_intro(),void hide_choices();"timeline"==now_showing()&&show_intro()}else t.hasClass("north")&&"timeline"==now_showing()?go_prev():t.hasClass("south")&&"timeline"==now_showing()&&go_next()}function update_page(){READY.then((()=>{let e=TIMELINE.current_page();$(".page_text").scrollTop(0).html(marked(e.text)),hide_choices(),render_score(TIMELINE.score_all()),render_pagebar(TIMELINE.page_loc()),render_choices(e.choices)}))}function is_page_top(){let e=$(".page_text");return 0==$(e).scrollTop()}function is_page_bottom(){let e=$(".page_text");return $(e).scrollTop()==$(e)[0].scrollHeight-$(e).height()}function on_text_scroll(e){let t=e.target,o=$(t).scrollTop();0==o&&(scroll_lock||lock_scroll("top")),o==$(t)[0].scrollHeight-$(t).height()&&(scroll_lock||lock_scroll("bottom"))}function render_score(e){$("#score").html(e.score),$("#out_of").html(e.out_of)}function render_pagebar(e){let t=e.page_count,o=e.page_index,s=100*o/(t-1);$(".progress-bar").css("width",s+"%"),$("#page_count").html(t),$("#page_index").html(o+1)}function render_choices(e){if($.isEmptyObject(e))return has_choices=!1,void $(".go_ab").hide();has_choices=!0,$(".go_ab").show();let t=$(".goback"),o=$("<h2/>").addClass("prompt").text("Will you change the timeline?"),s=$("<div/>").addClass("init").text("A"),c=$("<div/>").addClass("check ms-3").html($("<i/>").addClass(["far","fa-check"])),i=$("<div/>").addClass("text").text(e.A),n=$("<div/>").addClass("d-flex flex-row").append(s,c),a=$("<div/>").addClass("col choice a").append(n,i),l=$("<div/>").addClass("init").text("B"),r=$("<div/>").addClass("check ms-3").html($("<i/>").addClass(["far","fa-check"])),_=$("<div/>").addClass("text").text(e.B),h=$("<div/>").addClass("d-flex flex-row").append(l,r),d=$("<div/>").addClass("col choice b").append(h,_),g=$("<div/>").addClass("row").append(d,a);$(".choices").empty().append(o,g,t),active_choice="A",update_checks()}function update_checks(e){1==e&&"none"!=$(".choices").css("display")?$(".choices").fadeOut((()=>{redraw_checks(),$(".choices").fadeIn()})):redraw_checks()}function redraw_checks(){"A"==active_choice?($(".choice.a .check").show(),$(".choice.b .check").hide()):"B"==active_choice&&($(".choice.b .check").show(),$(".choice.a .check").hide())}function lock_scroll(e){scroll_lock||($(".bumper."+e).css("display","block").fadeOut("slow",unlock_scroll),scroll_lock=!0)}function unlock_scroll(){scroll_lock=!1}function show_choices(){$(".page_text").hide(),$(".go_ab").hide(),$(".choices").show()}function hide_choices(){$(".page_text").show(),has_choices&&$(".go_ab").show(),$(".choices").hide()}function locator(e){var t=e.getBoundingClientRect();let o=$("<div/>").addClass("loc").css({position:"absolute",left:t.x+window.scrollX,top:t.y+window.scrollY,width:t.width,height:t.height,"background-color":"#f805"});return $("body").append(o),o}function on_click_gear(){$(".gear_panel").toggleClass("closed")}function on_click_setcolor(e){let t=$(e.target).css("background-color");$(".case").css("background-color",t),CONFIG.setColor=t,save_config()}